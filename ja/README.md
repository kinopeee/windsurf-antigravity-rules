# Windsurf / Antigravity Rules 「v5」

🇯🇵 日本語版ドキュメント

[� トップページに戻る](../README.md) | [🇬🇧 English](../en/README.md)

このリポジトリは、Windsurf および Antigravity 用のカスタムインストラクションを管理するためのものです。

> **Note**: Cursor 版は別リポジトリ [kinopeee/cursorrules](https://github.com/kinopeee/cursorrules) を参照してください。

## 前提

- この`v5`は、Windsurf および Antigravity に最適化されたカスタムインストラクションです
- エージェントが自走（人の介入を受けずに自律処理）ができる前提として、各エディタの設定が適切に行われている必要があります。
- 最新の更新内容については[更新履歴](CHANGELOG.md)を参照してください。

## 概要

- AIエージェント機能がリリースされてから、様々なパターンの処理を通して感じたのが「分析力の不足」でした。そのため、モデル（当時のClaude 3.5 Sonnet）が本来持っている分析能力を引き出せるように工夫し始めたのが、私のカスタムインストラクション作成の始まりです。
- 当初のテーマは、分析能力向上と自走力を高めることがでしたが、その後、モジュールやリソースの重複生成、意図せぬ、AIによるデザインの変更、エラー処理の無限ループなどの防止にも取り組み、モデルの刷新と性能向上と相まって、それなりの成果を残せたように思います。
- このバージョンアップグレードのフォーカスは GPT-5.1 最適化です：
    1. チェックリスト式の実装計画を立ててから着手。実行後はチェックリストごとに完了を確認することで、より計画性の高いタスク遂行が可能になっています。
    1. タスクを軽量・標準・重要の3段階に分類し、軽量タスクでは1〜2文の簡潔な報告にとどめ、重いタスクほど手順と検証を厚くするようになっています。
    1. 並行処理できるタスクは並行処理を行うことで、処理速度が向上します。
- さらに、ファイル読み取り、編集、コマンド実行などのツール利用ポリシーを明文化し、常に安全な手順・権限でタスクを進めるワークフローを整備しています。
- `v5` は、初期にAnthropic Prompt Generatorで作成、それ以降、その時期の最新モデルによる評価、実践による改善を繰り返してきました。カスタマイズの際も、お使いになるAIによる評価を行うことを推奨します。
- 詳細な更新内容（タスク分類、エラー処理の段階化、ツール利用ポリシーなど）については[CHANGELOG.md](CHANGELOG.md)を参照してください。

- また、本リポジトリ自体がベストプラクティス例として、コミットメッセージ／PRメッセージのルールファイルおよびコミット・プッシュ・PR作成のワークフローコマンドのサンプルを含んでいます。

## 使用方法

### Windsurf

1. `.windsurf/rules` がまだ存在しない場合は、フォルダを作成してください。
2. `ja/.windsurf/rules/` または `en/.windsurf/rules/` から必要なルールファイルをコピーして配置してください。
3. ワークフローを使用する場合は、`.windsurf/workflows/` にコピーしてください。

### Antigravity

1. `.agent/rules` がまだ存在しない場合は、フォルダを作成してください。
2. `ja/.agent/rules/` または `en/.agent/rules/` から必要なルールファイルをコピーして配置してください。
3. ワークフローを使用する場合は、`.agent/workflows/` にコピーしてください。

### 共通事項

- これらのルールの適用条件はデフォルトで `trigger: always_on` となっているため、所定のパスに存在していれば、それ以降のチャットで自動的に参照されます。
- 利用したい言語やテストルールをデフォルトで有効にするかどうかに応じて、この設定を調整してください。
- これらを有効にすると、テストコードの実装・修正タスクでは、本リポジトリで定義した等価分割・境界値分析やカバレッジ要件などのテスト方針ルールが自動的に適用されます。

ルールファイルとワークフローの役割分担と使い方については、[doc/rules-and-workflows.md](doc/rules-and-workflows.md) を参照してください。

### ガードレール関連ファイル

以下のファイルは Windsurf (`.windsurf/rules/`) および Antigravity (`.agent/rules/`) の両方に対応しています。

- `commit-message-format.md`  
  - **役割**: コミットメッセージのフォーマット（Prefix、サマリ、箇条書き本文など）と禁止事項を定義するファイルです。
  - **特徴**: Conventional Commits をベースにしつつ、`language` による言語指定や差分ベースのメッセージ生成といったガイドラインを含みます。

- `pr-message-format.md`  
  - **役割**: PR タイトルおよび本文のフォーマット（Prefix 付きタイトル、構造化された「概要」「変更内容」「テスト内容」など）と禁止事項を定義するファイルです。
  - **特徴**: コミットメッセージ規約と整合する形で PR メッセージを構造化し、レビューや変更意図の把握をしやすくするためのガイドラインを提供します。

- `test-strategy.md`  
  - **役割**: テストコードの実装・修正タスク向けに、等価分割・境界値分析やカバレッジ要件などのテスト方針ルールを定義するファイルです。
  - **特徴**: 本番コードに意味のある変更が入る場合は対応する自動テストの追加・更新を求めるなど、品質面のガードレールとして機能します。

- `prompt-injection-guard.md`  
  - **役割**: **外部ソース（RAG、Web、ファイル、API応答等）からのコンテキストインジェクション攻撃** に対する防御ルールを定義するファイルです。
  - **内容**: 外部データ由来の命令制限、Instruction Quarantine、SECURITY_ALERT のフォーマット、ユーザー偽装検出など、外部からの攻撃を防ぎつつユーザーの正当な操作は妨げないガードレールを記述しています。
  - **特徴**: ユーザー自身の操作は制限せず、外部から注入された悪意ある命令のみを無効化します。
  - **注意**: このファイルのメタデータには `trigger: always_on` が設定されていますが、エディタの UI 設定でルールの適用タイミングを制御できます。誤検知への対処方法については[運用ガイド](doc/prompt-injection-guard.md)を参照してください。

- `planning-mode-guard.md` **(Antigravity専用)**
  - **役割**: Antigravity の Planning Mode における問題動作を防止するためのガードレールです。
  - **対処する問題**:
    - 指示していないのに実装フェーズへ移行してしまう
    - 日本語で指示しても英語で応答されることがある
  - **内容**: Planning Mode では分析・計画のみを行い、ユーザーの明示的な承認なしにファイル変更やコマンド実行を行わないよう制御します。また、ユーザーの言語設定に従った応答を促します。
  - **特徴**: `.agent/rules/` にのみ配置され、Windsurf では使用しません。

- `doc/custom_instruction_plan_prompt_injection.md`  
  - **役割**: 外部コンテキストインジェクション防御のための **設計・脅威分析ドキュメント**です。
  - **内容**: 外部ソース経由の攻撃カテゴリ（A-01〜A-09）、それに対応する防御要件（R-01〜R-08）、外部データ制御層の設計方針、検証・運用計画などを整理しています。
  - **更新**: 2024年11月に外部ソース攻撃に特化した内容に全面改訂されました。


## 翻訳ガイド

カスタムインストラクションを他言語へ翻訳する際の推奨プロンプトについては、[TRANSLATION_GUIDE.md](../TRANSLATION_GUIDE.md) を参照してください。

## 注意事項

- User Rules、Memories に v5 と矛盾する指示が存在すると、モデルが混乱して、効果が減少します。それぞれの内容を十分にご確認ください。

## ライセンス

MITライセンスの下で公開されています。詳細については[LICENSE](../LICENSE)ファイルを参照してください。

## サポート

- このリポジトリのサポートはありませんが、フィードバックは歓迎いたします。また、Cursor関連情報をX（Twitter）で発信しているので、ご興味あればご覧ください。
[X（Twitter）](https://x.com/kinopee_ai)
